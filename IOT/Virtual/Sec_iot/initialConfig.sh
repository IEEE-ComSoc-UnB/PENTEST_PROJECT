#!/bin/bash
echo "***Inicializando instalação***" && echo ""
sleep "2" ; echo "***INFO - Procurando dependências (isso pode demorar)***" && find / -name "pip3" &> /dev/null

if [ $? -ne 0 ] ; then

	echo "***INFO - Instalando pip3***" && echo ""
	apt-get -y install python3-pip &> /dev/null || echo "***ERR - Instalação falhou***" #; exit
	echo "" && echo "***INFO - pip3 instalado com sucesso"

	ls -l /usr/lib/iot-server &> /dev/null

	if [ $? -ne 0 ] ; then

		echo "***INFO - Criando pasta /usr/lib/iot-server***" && mkdir /usr/lib/iot-server && echo "*****INFO - Pasta /usr/local/iot-server criada***"
		echo "***INFO - Copiando dependências***" && cp ./main.py /usr/lib/iot-server && cp -R ./classes/ /usr/lib/iot-server && cp -R ./config/ /usr/lib/iot-server && cp -R ./systemdService/ /usr/lib/iot-server && echo ""
		echo "***INFO - Dependências copiadas***" && cd ./systemdService/ && cp iot-controller.service /etc/systemd/system
		echo "***WARN - INSTALAÇÃO COMPLETA - para inicializar o serviço execute: systemctl start iot-server.service***"

	else

		echo "***INFO - Pasta /usr/local/iot-server já existe***" && rm -rf /usr/lib/iot-server/* && echo " "
		echo "***INFO - Copiando dependências***" && cp ./main.py /usr/lib/iot-server && cp -R ./classes/ /usr/lib/iot-server && cp -R ./config/ /usr/lib/iot-server && cp -R ./systemdService/ /usr/lib/iot-server && echo ""
		echo "***INFO - Dependências copiadas***" && cd ./systemdService/ && cp iot-controller.service /etc/systemd/system
		echo "***WARN - INSTALAÇÃO COMPLETA - para inicializar o serviço execute: systemctl start iot-server.service***"

	fi

else
	echo "***INFO - pip3 já instalado no sistema***"  && echo " "
	ls -l /usr/lib/iot-server &> /dev/null

	if [ $? -ne 0 ] ; then

		echo "***INFO - Criando pasta /usr/lib/iot-server***" && mkdir /usr/lib/iot-server && echo "*****INFO - Pasta /usr/local/iot-server criada*"
		echo "***INFO - Copiando dependências***" && cp ./main.py /usr/lib/iot-server && cp -R ./classes/ /usr/lib/iot-server && cp -R ./config/ /usr/lib/iot-server && cp -R ./systemdService/ /usr/lib/iot-server && echo ""
		echo "***INFO - Dependências copiadas***" && cd ./systemdService/ && cp iot-controller.service /etc/systemd/system
		echo "***WARN - INSTALAÇÃO COMPLETA - para inicializar o serviço execute: systemctl start iot-server.service***"

	else

		echo "***INFO - Pasta /usr/local/iot-server já existe***" && rm -rf /usr/lib/iot-server/* && echo " "
		echo "***INFO - Copiando dependências***" && cp ./main.py /usr/lib/iot-server && cp -R ./classes/ /usr/lib/iot-server && cp -R ./config/ /usr/lib/iot-server && cp -R ./systemdService/ /usr/lib/iot-server && echo ""
		echo "***INFO - Dependências copiadas***" && cd ./systemdService/ && cp iot-controller.service /etc/systemd/system
		echo "***WARN - INSTALAÇÃO COMPLETA - Para inicializar execute: python3 /usr/lib/iot-server/main.py***" && echo ""

	fi
fi

python3 /usr/lib/iot-server/main.py

